    processor 6502
    include "../UTILS/vcs.h"
    include "../UTILS/macro.h"

    seg.u Variables
    org $80
Channel_1Duration = $80
Channel_1Counter = $81	; This is a pointer, needs 16 bits
Channel_2Duration = $83
Channel_2Counter = $84	; This is a pointer, needs 16 bits.

    seg Code
    org $F000

RestartMusic:
    CLEAN_START 
	LDA	#1
	STA	Channel_1Duration
	STA	Channel_2Duration
	LDA	#<MusicChannel_1
	STA	Channel_1Counter
	LDA	#>MusicChannel_1
	STA	Channel_1Counter+1
	LDA	#<MusicChannel_2
	STA	Channel_2Counter
	LDA	#>MusicChannel_2
	STA	Channel_2Counter+1


Game:
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Generate the three lines of VSYNC
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    sta WSYNC            ; first scanline
    sta WSYNC            ; second scanline
    sta WSYNC            ; third scanline

    lda #0
    sta VSYNC            ; turn off VSYNC

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Let the TIA output the recommended 37 scanlines of VBLANK 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ldx #37              ; X = 37
LoopVBlank:
    sta WSYNC           ; hit WSYNC and wait for the next scanline
    dex                 ; X--
    bne LoopVBlank      ; loop while X != 0
    lda #0
    sta VBLANK          ; turn off the VBLANK

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Draw 192 visible scanlines (kernel) 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ldx #192            ; counter for 192 visible scanlines
LoopVisible:
    ;stx COLUBK          ; set the background color
    sta WSYNC           ; wait for the next scanline
    dex                 ; X--
    bne LoopVisible     ; loop while X != 0

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Output 30 more VBLANK lines (overscan) to complete our frame 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    lda #2              ; hit and turn on VBLANK again
    sta VBLANK

    ldx #30             ; counter for 30 scanlines
LoopOverscan:
    sta WSYNC           ; wait for the next scanline
    dex                 ; X--
    bne LoopOverscan    ; loop while X != 0
 
Music_Player:
LoadNext1:
	DEC	Channel_1Duration
	LDA	Channel_1Duration
	BNE	LoadNext2
	LDX	#Channel_1Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	CMP	#255
	BNE	Not255_1
	LDA	#<MusicChannel_1
	STA	Channel_1Counter
	LDA	#>MusicChannel_1
	STA	Channel_1Counter+1
	LDX	#Channel_1Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
Not255_1:
	STA	AUDV0
	CMP	#0
	BEQ	GotoDuration1
	lsr
	lsr
	lsr
	lsr
	STA	AUDC0
	LDX	#Channel_1Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	STA	AUDF0
GotoDuration1:
	LDX	#Channel_1Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	STA	Channel_1Duration
LoadNext2:
	DEC	Channel_2Duration
	LDA	Channel_2Duration
	BNE	LoadEnd
	LDX	#Channel_2Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	CMP	#255
	BNE	Not255_2
	LDA	#<MusicChannel_2
	STA	Channel_2Counter
	LDA	#>MusicChannel_2
	STA	Channel_2Counter+1
	LDX	#Channel_2Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
Not255_2:
	STA	AUDV1
	CMP	#0
	BEQ	GotoDuration2
	lsr
	lsr
	lsr
	lsr
	STA	AUDC1
	LDX	#Channel_2Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	STA	AUDF1
GotoDuration2:
	LDX	#Channel_2Counter
	LDA	(0,x)
	INC	0,x
	BNE	*+4
	INC	1,x
	STA	Channel_2Duration
LoadEnd:
	JMP	Game
MusicChannel_1:
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#48
	.BYTE	#0
	.BYTE	#27
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#20
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#48
	.BYTE	#0
	.BYTE	#27
	.BYTE	#%01001000
	.BYTE	#17
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#19
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#20
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#48
	.BYTE	#0
	.BYTE	#2
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#14
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#14
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%11001000
	.BYTE	#12
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#%11001000
	.BYTE	#13
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#10
	.BYTE	#%11000010
	.BYTE	#11
	.BYTE	#2
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#14
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%11001000
	.BYTE	#12
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#23
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#26
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#29
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#%01001000
	.BYTE	#31
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#%11001000
	.BYTE	#13
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#10
	.BYTE	#%11000010
	.BYTE	#11
	.BYTE	#2
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#24
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#13
	.BYTE	#6
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#11
	.BYTE	#12
	.BYTE	#255

MusicChannel_2:
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#16
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#2
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#26
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#16
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#2
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#18
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#6
	.BYTE	#0
	.BYTE	#26
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#16
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#2
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#18
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#6
	.BYTE	#0
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#18
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#18
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#18
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#6
	.BYTE	#0
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#25
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#18
	.BYTE	#0
	.BYTE	#1
	.BYTE	#%11001000
	.BYTE	#31
	.BYTE	#6
	.BYTE	#0
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#16
	.BYTE	#6
	.BYTE	#%00010001
	.BYTE	#16
	.BYTE	#25
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#18
	.BYTE	#%00010001
	.BYTE	#15
	.BYTE	#1
	.BYTE	#%00010010
	.BYTE	#15
	.BYTE	#6
	.BYTE	#0
	.BYTE	#7
	.BYTE	#255

    org $fffc

    .word RestartMusic
    .word RestartMusic
